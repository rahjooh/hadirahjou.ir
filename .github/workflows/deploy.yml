name: Deploy to Production

on:
  push:
    branches:
      - main

env:
  DEPLOY_ENVIRONMENT_NAME: ${{ vars.DEPLOY_ENVIRONMENT_NAME || vars.DEPLOY_ENV || 'host' }}

jobs:
  quality-checks:
    name: Static analysis and build verification
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Run lint/type-check
        run: npm run lint

      - name: Build project
        run: NODE_OPTIONS="--max-old-space-size=2048" npm run build

  ssh-test:
    name: Verify SSH connectivity
    runs-on: ubuntu-latest
    needs: quality-checks
    environment:
      name: ${{ vars.DEPLOY_ENVIRONMENT_NAME || vars.DEPLOY_ENV || 'host' }}
    env:
      SSH_HOST: ${{ secrets.SSH_HOST || secrets.IP || vars.SSH_HOST || vars.IP }}
      SSH_USER: ${{ secrets.SSH_USER || secrets.USER || vars.SSH_USER || vars.USERNAME || vars.USER }}
      SSH_PASSWORD: ${{ secrets.SSH_PASSWORD || secrets.PASS || secrets.PASSWORD || vars.SSH_PASSWORD || vars.PASS || vars.PASSWORD }}
      SSH_PORT: ${{ secrets.SSH_PORT || vars.SSH_PORT || 22 }}

    steps:
      - name: Validate connection settings
        run: |
          if [ -z "${SSH_HOST}" ]; then
            echo "::error::Missing SSH host. Please define a secret or variable such as SSH_HOST or IP." >&2
            exit 1
          fi
          if [ -z "${SSH_USER}" ]; then
            echo "::error::Missing SSH username. Please define a secret or variable such as SSH_USER or USER." >&2
            exit 1
          fi
          if [ -z "${SSH_PASSWORD}" ]; then
            echo "::error::Missing SSH password. Please define a secret or variable such as SSH_PASSWORD, PASS, or PASSWORD." >&2
            exit 1
          fi

      - name: Test SSH connection
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          password: ${{ env.SSH_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            echo "SSH connection successful"

      - name: Ensure Nginx is installed and configured
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          password: ${{ env.SSH_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            set -eu
            if [ -n "${BASH:-}" ]; then
              set -o pipefail
            fi

            if command -v sudo >/dev/null 2>&1; then
              SUDO="sudo"
            else
              SUDO=""
            fi

            if ! command -v nginx >/dev/null 2>&1; then
              $SUDO apt-get update
              $SUDO apt-get install -y nginx
            fi

            SITE_CONF="/etc/nginx/sites-available/hadirahjou-ir"
            SITE_LINK="/etc/nginx/sites-enabled/hadirahjou-ir"
            APP_DIR="$HOME/apps/hadirahjou.ir"
            
            # Check if SSL certificates exist
            SSL_CERT="/etc/letsencrypt/live/hadirahjou.ir/fullchain.pem"
            SSL_KEY="/etc/letsencrypt/live/hadirahjou.ir/privkey.pem"
            
            if [ ! -f "$SSL_CERT" ] || [ ! -f "$SSL_KEY" ]; then
              echo "WARNING: SSL certificates not found at $SSL_CERT or $SSL_KEY"
              echo "Creating nginx config without SSL (HTTP only) - will be updated during deployment"
              
              # Create HTTP-only config for now
              $SUDO tee "$SITE_CONF" >/dev/null <<EOF
            server {
                listen 80;
                listen [::]:80;
                server_name hadirahjou.ir www.hadirahjou.ir;
                
                # Root directory for static files
                root ${APP_DIR}/out;
                index index.html;
                
                # Gzip compression
                gzip on;
                gzip_vary on;
                gzip_min_length 1024;
                gzip_types text/css application/javascript application/json
                           text/plain text/xml text/javascript
                           application/x-javascript application/xml+rss;
                
                # Cache static assets
                location /_next/static {
                    expires 1y;
                    add_header Cache-Control "public, immutable";
                    access_log off;
                }
                
                # Serve HTML files
                location / {
                    try_files \$uri \$uri.html \$uri/ =404;
                }
            }
            EOF
            else
              echo "SSL certificates found, creating full HTTPS config"
              
              # Create full HTTPS config
              $SUDO tee "$SITE_CONF" >/dev/null <<EOF
            server {
                listen 80;
                listen [::]:80;
                server_name hadirahjou.ir www.hadirahjou.ir;

                # Redirect HTTP to HTTPS
                return 301 https://\$host\$request_uri;
            }

            server {
                listen 443 ssl http2;
                listen [::]:443 ssl http2;
                server_name hadirahjou.ir www.hadirahjou.ir;

                ssl_certificate $SSL_CERT;
                ssl_certificate_key $SSL_KEY;

                ssl_protocols TLSv1.2 TLSv1.3;
                ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES128-GCM-SHA256';
                ssl_prefer_server_ciphers off;

                # Root directory for static files
                root ${APP_DIR}/out;
                index index.html;

                # Gzip compression
                gzip on;
                gzip_vary on;
                gzip_min_length 1024;
                gzip_types text/css application/javascript application/json
                           text/plain text/xml text/javascript
                           application/x-javascript application/xml+rss;

                # Cache static assets
                location /_next/static {
                    expires 1y;
                    add_header Cache-Control "public, immutable";
                    access_log off;
                }

                # Serve HTML files
                location / {
                    try_files \$uri \$uri.html \$uri/ =404;
                }
            }
            EOF
            fi

            $SUDO ln -sf "$SITE_CONF" "$SITE_LINK"

            if [ -e /etc/nginx/sites-enabled/default ]; then
              $SUDO rm -f /etc/nginx/sites-enabled/default
            fi

            # Test nginx config (don't fail if it has issues, deployment step will fix it)
            if $SUDO nginx -t; then
              echo "Nginx config test passed"
              $SUDO systemctl reload nginx || $SUDO systemctl restart nginx || true
            else
              echo "WARNING: Nginx config test failed, but continuing. Will be fixed during deployment."
            fi

  deploy:
    name: Deploy to hadirahjou.ir
    runs-on: ubuntu-latest
    needs: ssh-test
    environment:
      name: ${{ vars.DEPLOY_ENVIRONMENT_NAME || vars.DEPLOY_ENV || 'host' }}
    env:
      SSH_HOST: ${{ secrets.SSH_HOST || secrets.IP || vars.SSH_HOST || vars.IP }}
      SSH_USER: ${{ secrets.SSH_USER || secrets.USER || vars.SSH_USER || vars.USERNAME || vars.USER }}
      SSH_PASSWORD: ${{ secrets.SSH_PASSWORD || secrets.PASS || secrets.PASSWORD || vars.SSH_PASSWORD || vars.PASS || vars.PASSWORD }}
      SSH_PORT: ${{ secrets.SSH_PORT || vars.SSH_PORT || 22 }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Build project
        run: NODE_OPTIONS="--max-old-space-size=4096" npm run build
        env:
          NODE_ENV: production

      - name: Verify build output
        run: |
          if [ ! -d "out" ]; then
            echo "::error::Build failed - out directory not found"
            exit 1
          fi
          echo "Build output verified: out directory exists"

      - name: Prepare deployment archive
        run: |
          set -euo pipefail

          ARCHIVE_PATH="${RUNNER_TEMP}/deploy.tar.gz"

          # Remove dev dependencies and keep only production files
          rm -rf node_modules
          rm -f "$ARCHIVE_PATH" deploy.tar.gz

          # Create archive with only the static export output directory
          # Static export creates an 'out' directory with all static files
          tar czf "$ARCHIVE_PATH" \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='deploy.tar.gz' \
            --exclude='deploy.tar.gz.*' \
            out/

          mv "$ARCHIVE_PATH" ./deploy.tar.gz
          echo "Deployment archive created successfully (static export)"

      - name: Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: Upload archive to server
        env:
          SSH_PORT: ${{ env.SSH_PORT }}
        run: |
          set -euo pipefail

          SSH_PORT="${SSH_PORT:-22}"
          REMOTE="${SSH_USER}@${SSH_HOST}"
          REMOTE_DIR="~/deployments"
          ARCHIVE_NAME="deploy.tar.gz"
          REMOTE_PATH="$REMOTE_DIR/$ARCHIVE_NAME"
          RETRIES=5
          SLEEP_BETWEEN=10

          sshpass -p "$SSH_PASSWORD" \
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 -p "$SSH_PORT" "$REMOTE" "mkdir -p ${REMOTE_DIR}"

          for attempt in $(seq 1 "$RETRIES"); do
            echo "Uploading archive (attempt ${attempt}/${RETRIES})"
            if sshpass -p "$SSH_PASSWORD" \
              scp -o StrictHostKeyChecking=no -o ConnectTimeout=30 -P "$SSH_PORT" "$ARCHIVE_NAME" "$REMOTE:$REMOTE_PATH"; then
              echo "Upload complete"
              exit 0
            fi

            if [ "$attempt" -lt "$RETRIES" ]; then
              echo "Upload failed, retrying in ${SLEEP_BETWEEN}s"
              sleep "$SLEEP_BETWEEN"
            else
              echo "::error::Failed to upload archive after ${RETRIES} attempts"
              exit 1
            fi
          done

      - name: Deploy on remote host
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          password: ${{ env.SSH_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            set -eu
            if [ -n "${BASH:-}" ]; then
              set -o pipefail
            fi

            ARCHIVE_DIR="$HOME/deployments"
            ARCHIVE_NAME="deploy.tar.gz"
            ARCHIVE_PATH="$ARCHIVE_DIR/$ARCHIVE_NAME"
            APP_DIR="$HOME/apps/hadirahjou.ir"

            mkdir -p "$ARCHIVE_DIR"

            if command -v sudo >/dev/null 2>&1; then
              SUDO="sudo"
            else
              SUDO=""
            fi

            # Remove old deployment
            rm -rf "$APP_DIR"
            mkdir -p "$APP_DIR"
            
            # Extract static files (out directory) to app directory
            # The archive contains 'out/' directory, so we extract it directly
            tar -xzf "$ARCHIVE_PATH" -C "$APP_DIR"
            rm -f "$ARCHIVE_PATH"
            
            # Verify the out directory exists and has files
            if [ ! -d "$APP_DIR/out" ] || [ -z "$(ls -A $APP_DIR/out 2>/dev/null)" ]; then
              echo "Error: out directory is missing or empty after extraction"
              echo "APP_DIR contents:"
              ls -la "$APP_DIR" || true
              if [ -f "$ARCHIVE_PATH" ]; then
                echo "Archive contents:"
                tar -tzf "$ARCHIVE_PATH" 2>/dev/null | head -20 || echo "Could not list archive"
              fi
              exit 1
            fi
            
            # Set proper permissions for nginx to read the files
            # First, ensure parent directories are accessible
            $SUDO chmod 755 "$HOME" 2>/dev/null || true
            $SUDO chmod 755 "$HOME/apps" 2>/dev/null || true
            $SUDO chmod 755 "$APP_DIR" 2>/dev/null || true
            
            # Set permissions on out directory and files
            # Make directories readable and executable by all
            $SUDO find "$APP_DIR/out" -type d -exec chmod 755 {} \;
            # Make files readable by all
            $SUDO find "$APP_DIR/out" -type f -exec chmod 644 {} \;
            
            # Also ensure www-data can access (change ownership or add to group)
            NGINX_USER="www-data"
            if id "$NGINX_USER" &>/dev/null; then
              # Try to change ownership to www-data, or at least ensure group permissions
              $SUDO chown -R "$NGINX_USER:$NGINX_USER" "$APP_DIR/out" 2>/dev/null || {
                # If chown fails, ensure world-readable permissions
                echo "Could not change ownership, ensuring world-readable permissions..."
                $SUDO chmod -R a+rX "$APP_DIR/out"
              }
            else
              # If www-data doesn't exist, just make world-readable
              $SUDO chmod -R a+rX "$APP_DIR/out"
            fi
            
            echo "Static files extracted successfully to $APP_DIR/out"
            echo "Contents of out directory:"
            ls -la "$APP_DIR/out" | head -20 || true
            echo "Checking for index.html:"
            ls -la "$APP_DIR/out/index.html" || echo "WARNING: index.html not found!"
            
            # Get absolute paths
            ABS_APP_DIR="$(cd "$APP_DIR" && pwd)"
            ABS_OUT_DIR="$ABS_APP_DIR/out"
            
            # Rewrite nginx config with the correct absolute path
            SITE_CONF="/etc/nginx/sites-available/hadirahjou-ir"
            SITE_LINK="/etc/nginx/sites-enabled/hadirahjou-ir"
            
            echo "Creating/updating nginx config with path: $ABS_OUT_DIR"
            
            # Create nginx config - write with indentation then remove leading whitespace
            $SUDO tee "$SITE_CONF" >/dev/null <<EOF
            server {
                listen 80;
                listen [::]:80;
                server_name hadirahjou.ir www.hadirahjou.ir;
                return 301 https://\$host\$request_uri;
            }
            server {
                listen 443 ssl http2;
                listen [::]:443 ssl http2;
                server_name hadirahjou.ir www.hadirahjou.ir;
                ssl_certificate /etc/letsencrypt/live/hadirahjou.ir/fullchain.pem;
                ssl_certificate_key /etc/letsencrypt/live/hadirahjou.ir/privkey.pem;
                ssl_protocols TLSv1.2 TLSv1.3;
                ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES128-GCM-SHA256';
                ssl_prefer_server_ciphers off;
                root $ABS_OUT_DIR;
                index index.html;
                gzip on;
                gzip_vary on;
                gzip_min_length 1024;
                gzip_types text/css application/javascript application/json
                           text/plain text/xml text/javascript
                           application/x-javascript application/xml+rss;
                location /_next/static {
                    expires 1y;
                    add_header Cache-Control "public, immutable";
                    access_log off;
                }
                location / {
                    try_files \$uri \$uri.html \$uri/ =404;
                }
            }
            EOF
            
            # Remove leading whitespace from nginx config (12 spaces from heredoc indentation)
            $SUDO sed -i 's/^            //' "$SITE_CONF"

            # Enable the site
            $SUDO ln -sf "$SITE_CONF" "$SITE_LINK"
            
            echo "Nginx config created/updated. Root path: $ABS_OUT_DIR"
            
            # Test nginx config
            if $SUDO nginx -t; then
              echo "✓ Nginx config test passed"
            else
              echo "ERROR: nginx config test failed!"
              $SUDO nginx -t
              exit 1
            fi

            # Verify nginx can access the files
            if [ -f "$ABS_OUT_DIR/index.html" ]; then
              echo "✓ index.html exists at $ABS_OUT_DIR/index.html"
              # Check if nginx user can read it
              if $SUDO test -r "$ABS_OUT_DIR/index.html"; then
                echo "✓ nginx can read index.html"
              else
                echo "WARNING: nginx might not be able to read the files"
                # Try to fix permissions - make files world-readable
                $SUDO chmod -R 755 "$ABS_OUT_DIR"
                $SUDO find "$ABS_OUT_DIR" -type f -exec chmod 644 {} \;
                echo "Fixed permissions on $ABS_OUT_DIR"
              fi
            fi
            
            # Test if we can read the file as the nginx user
            NGINX_USER="www-data"
            if id "$NGINX_USER" &>/dev/null; then
              if $SUDO -u "$NGINX_USER" test -r "$ABS_OUT_DIR/index.html"; then
                echo "✓ Confirmed: $NGINX_USER can read index.html"
              else
                echo "WARNING: $NGINX_USER cannot read index.html, fixing permissions..."
                # Ensure all parent directories are accessible
                $SUDO chmod 755 "$HOME" 2>/dev/null || true
                $SUDO chmod 755 "$HOME/apps" 2>/dev/null || true
                $SUDO chmod 755 "$ABS_APP_DIR" 2>/dev/null || true
                # Fix permissions on the out directory
                $SUDO chown -R "$NGINX_USER:$NGINX_USER" "$ABS_OUT_DIR" 2>/dev/null || {
                  $SUDO chmod -R a+rX "$ABS_OUT_DIR"
                }
                # Verify it works now
                if $SUDO -u "$NGINX_USER" test -r "$ABS_OUT_DIR/index.html"; then
                  echo "✓ Permissions fixed: $NGINX_USER can now read index.html"
                else
                  echo "✗ ERROR: Still cannot read after fixing permissions!"
                fi
              fi
            fi
            
            # Verify nginx config is enabled
            SITE_LINK="/etc/nginx/sites-enabled/hadirahjou-ir"
            if [ ! -L "$SITE_LINK" ] || [ ! -f "$SITE_LINK" ]; then
              echo "WARNING: nginx config not enabled, creating symlink..."
              $SUDO ln -sf "$SITE_CONF" "$SITE_LINK"
            fi
            
            # Show final nginx config for debugging
            echo "Final nginx server block for hadirahjou.ir:"
            $SUDO sed -n '/server_name hadirahjou.ir/,/^[[:space:]]*}/p' "$SITE_CONF" || echo "Could not show nginx config"
            
            # List all enabled nginx sites
            echo "Enabled nginx sites:"
            $SUDO ls -la /etc/nginx/sites-enabled/ || true

            # Reload nginx to serve the new static files
            if command -v nginx >/dev/null 2>&1; then
              if command -v systemctl >/dev/null 2>&1; then
                $SUDO systemctl reload nginx || $SUDO systemctl restart nginx || true
                echo "Nginx reloaded/restarted"
              else
                $SUDO nginx -s reload || $SUDO service nginx reload || true
                echo "Nginx reloaded"
              fi
            fi
            
            # DEBUGGING: Comprehensive checks to diagnose 404 issues
            echo "=== DEBUGGING INFORMATION ==="
            
            # 1. Show the actual nginx config file contents
            echo "--- Nginx config file contents ---"
            $SUDO cat "$SITE_CONF" || echo "Could not read nginx config"
            
            # 2. Verify nginx is running
            echo "--- Nginx status ---"
            if command -v systemctl >/dev/null 2>&1; then
              $SUDO systemctl status nginx --no-pager -l || true
            else
              $SUDO service nginx status || true
            fi
            
            # 3. Check nginx error logs (last 20 lines)
            echo "--- Recent nginx error logs ---"
            if [ -f /var/log/nginx/error.log ]; then
              $SUDO tail -20 /var/log/nginx/error.log || echo "Could not read error log"
            else
              echo "Error log not found at /var/log/nginx/error.log"
              echo "Searching for error logs..."
              $SUDO find /var/log -name "*nginx*error*" 2>/dev/null | head -5 || true
            fi
            
            # 4. Check nginx access logs (last 10 lines)
            echo "--- Recent nginx access logs ---"
            if [ -f /var/log/nginx/access.log ]; then
              $SUDO tail -10 /var/log/nginx/access.log || echo "Could not read access log"
            else
              echo "Access log not found at /var/log/nginx/access.log"
            fi
            
            # 5. Test if nginx can actually read the files
            echo "--- Testing file accessibility ---"
            if [ -f "$ABS_OUT_DIR/index.html" ]; then
              echo "✓ index.html exists: $ABS_OUT_DIR/index.html"
              $SUDO ls -la "$ABS_OUT_DIR/index.html" || true
              
              # Test as nginx user
              NGINX_USER="www-data"
              if id "$NGINX_USER" &>/dev/null; then
                echo "Testing file access as $NGINX_USER:"
                $SUDO -u "$NGINX_USER" test -r "$ABS_OUT_DIR/index.html" && echo "✓ $NGINX_USER can read index.html" || echo "✗ $NGINX_USER CANNOT read index.html"
                $SUDO -u "$NGINX_USER" test -x "$ABS_OUT_DIR" && echo "✓ $NGINX_USER can access directory" || echo "✗ $NGINX_USER CANNOT access directory"
              fi
            else
              echo "✗ ERROR: index.html does not exist at $ABS_OUT_DIR/index.html"
            fi
            
            # 6. Verify the root path in nginx config matches actual path
            echo "--- Verifying nginx root path ---"
            CONFIG_ROOT=$($SUDO grep -E "^\s*root\s+" "$SITE_CONF" | head -1 | sed 's/.*root[[:space:]]*\([^;]*\);.*/\1/' | xargs)
            echo "Root path in config: '$CONFIG_ROOT'"
            echo "Actual out directory: '$ABS_OUT_DIR'"
            if [ "$CONFIG_ROOT" = "$ABS_OUT_DIR" ]; then
              echo "✓ Paths match"
            else
              echo "✗ WARNING: Paths do not match!"
            fi
            
            # 7. Test nginx config syntax in detail
            echo "--- Detailed nginx config test ---"
            $SUDO nginx -t -c /etc/nginx/nginx.conf 2>&1 || true
            
            # 8. Check which nginx config is actually being used
            echo "--- Active nginx configuration ---"
            $SUDO nginx -T 2>/dev/null | grep -A 30 "server_name hadirahjou.ir" || echo "Could not extract active config"
            
            # 9. List files in the out directory
            echo "--- Files in out directory ---"
            ls -la "$ABS_OUT_DIR" | head -15 || true
            
            # 10. Test direct file access
            echo "--- Testing direct file access ---"
            if [ -f "$ABS_OUT_DIR/index.html" ]; then
              echo "File size: $(stat -c%s "$ABS_OUT_DIR/index.html" 2>/dev/null || stat -f%z "$ABS_OUT_DIR/index.html" 2>/dev/null) bytes"
              echo "First 100 chars of index.html:"
              head -c 100 "$ABS_OUT_DIR/index.html" || true
              echo ""
            fi
            
            echo "=== END DEBUGGING INFORMATION ==="
