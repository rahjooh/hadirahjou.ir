name: Deploy to Production

on:
  push:
    branches:
      - main

env:
  DEPLOY_ENVIRONMENT_NAME: ${{ vars.DEPLOY_ENVIRONMENT_NAME || vars.DEPLOY_ENV || 'host' }}

jobs:
  quality-checks:
    name: Static analysis and build verification
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Run lint/type-check
        run: npm run lint

      - name: Build project
        run: NODE_OPTIONS="--max-old-space-size=2048" npm run build

  ssh-test:
    name: Verify SSH connectivity
    runs-on: ubuntu-latest
    needs: quality-checks
    environment:
      name: ${{ vars.DEPLOY_ENVIRONMENT_NAME || vars.DEPLOY_ENV || 'host' }}
    env:
      SSH_HOST: ${{ secrets.SSH_HOST || secrets.IP || vars.SSH_HOST || vars.IP }}
      SSH_USER: ${{ secrets.SSH_USER || secrets.USER || vars.SSH_USER || vars.USERNAME || vars.USER }}
      SSH_PASSWORD: ${{ secrets.SSH_PASSWORD || secrets.PASS || secrets.PASSWORD || vars.SSH_PASSWORD || vars.PASS || vars.PASSWORD }}
      SSH_PORT: ${{ secrets.SSH_PORT || vars.SSH_PORT || 22 }}

    steps:
      - name: Validate connection settings
        run: |
          if [ -z "${SSH_HOST}" ]; then
            echo "::error::Missing SSH host. Please define a secret or variable such as SSH_HOST or IP." >&2
            exit 1
          fi
          if [ -z "${SSH_USER}" ]; then
            echo "::error::Missing SSH username. Please define a secret or variable such as SSH_USER or USER." >&2
            exit 1
          fi
          if [ -z "${SSH_PASSWORD}" ]; then
            echo "::error::Missing SSH password. Please define a secret or variable such as SSH_PASSWORD, PASS, or PASSWORD." >&2
            exit 1
          fi

      - name: Test SSH connection
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          password: ${{ env.SSH_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            echo "SSH connection successful"

      - name: Ensure Nginx is installed and configured
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          password: ${{ env.SSH_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            set -eu
            if [ -n "${BASH:-}" ]; then
              set -o pipefail
            fi

            if command -v sudo >/dev/null 2>&1; then
              SUDO="sudo"
            else
              SUDO=""
            fi

            if ! command -v nginx >/dev/null 2>&1; then
              $SUDO apt-get update
              $SUDO apt-get install -y nginx
            fi

            SITE_CONF="/etc/nginx/sites-available/hadirahjou-ir"
            SITE_LINK="/etc/nginx/sites-enabled/hadirahjou-ir"
            APP_DIR="$HOME/apps/hadirahjou.ir"

            $SUDO tee "$SITE_CONF" >/dev/null <<EOF
            server {
                listen 80;
                listen [::]:80;
                server_name hadirahjou.ir www.hadirahjou.ir;

                # Redirect HTTP to HTTPS
                return 301 https://\$host\$request_uri;
            }

            server {
                listen 443 ssl http2;
                listen [::]:443 ssl http2;
                server_name hadirahjou.ir www.hadirahjou.ir;

                ssl_certificate /etc/letsencrypt/live/hadirahjou.ir/fullchain.pem;
                ssl_certificate_key /etc/letsencrypt/live/hadirahjou.ir/privkey.pem;

                ssl_protocols TLSv1.2 TLSv1.3;
                ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES128-GCM-SHA256';
                ssl_prefer_server_ciphers off;

                # Root directory for static files
                root ${APP_DIR}/out;
                index index.html;

                # Gzip compression
                gzip on;
                gzip_vary on;
                gzip_min_length 1024;
                gzip_types text/css application/javascript application/json
                           text/plain text/xml text/javascript
                           application/x-javascript application/xml+rss;

                # Cache static assets
                location /_next/static {
                    expires 1y;
                    add_header Cache-Control "public, immutable";
                    access_log off;
                }

                # Serve HTML files
                location / {
                    try_files \$uri \$uri.html \$uri/ =404;
                }
            }
            EOF

            $SUDO ln -sf "$SITE_CONF" "$SITE_LINK"

            if [ -e /etc/nginx/sites-enabled/default ]; then
              $SUDO rm -f /etc/nginx/sites-enabled/default
            fi

            $SUDO nginx -t
            $SUDO systemctl restart nginx

  deploy:
    name: Deploy to hadirahjou.ir
    runs-on: ubuntu-latest
    needs: ssh-test
    environment:
      name: ${{ vars.DEPLOY_ENVIRONMENT_NAME || vars.DEPLOY_ENV || 'host' }}
    env:
      SSH_HOST: ${{ secrets.SSH_HOST || secrets.IP || vars.SSH_HOST || vars.IP }}
      SSH_USER: ${{ secrets.SSH_USER || secrets.USER || vars.SSH_USER || vars.USERNAME || vars.USER }}
      SSH_PASSWORD: ${{ secrets.SSH_PASSWORD || secrets.PASS || secrets.PASSWORD || vars.SSH_PASSWORD || vars.PASS || vars.PASSWORD }}
      SSH_PORT: ${{ secrets.SSH_PORT || vars.SSH_PORT || 22 }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Build project
        run: NODE_OPTIONS="--max-old-space-size=4096" npm run build
        env:
          NODE_ENV: production

      - name: Verify build output
        run: |
          if [ ! -d "out" ]; then
            echo "::error::Build failed - out directory not found"
            exit 1
          fi
          echo "Build output verified: out directory exists"

      - name: Prepare deployment archive
        run: |
          set -euo pipefail

          ARCHIVE_PATH="${RUNNER_TEMP}/deploy.tar.gz"

          # Remove dev dependencies and keep only production files
          rm -rf node_modules
          rm -f "$ARCHIVE_PATH" deploy.tar.gz

          # Create archive with only the static export output directory
          # Static export creates an 'out' directory with all static files
          tar czf "$ARCHIVE_PATH" \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='deploy.tar.gz' \
            --exclude='deploy.tar.gz.*' \
            out/

          mv "$ARCHIVE_PATH" ./deploy.tar.gz
          echo "Deployment archive created successfully (static export)"

      - name: Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: Upload archive to server
        env:
          SSH_PORT: ${{ env.SSH_PORT }}
        run: |
          set -euo pipefail

          SSH_PORT="${SSH_PORT:-22}"
          REMOTE="${SSH_USER}@${SSH_HOST}"
          REMOTE_DIR="~/deployments"
          ARCHIVE_NAME="deploy.tar.gz"
          REMOTE_PATH="$REMOTE_DIR/$ARCHIVE_NAME"
          RETRIES=5
          SLEEP_BETWEEN=10

          sshpass -p "$SSH_PASSWORD" \
            ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 -p "$SSH_PORT" "$REMOTE" "mkdir -p ${REMOTE_DIR}"

          for attempt in $(seq 1 "$RETRIES"); do
            echo "Uploading archive (attempt ${attempt}/${RETRIES})"
            if sshpass -p "$SSH_PASSWORD" \
              scp -o StrictHostKeyChecking=no -o ConnectTimeout=30 -P "$SSH_PORT" "$ARCHIVE_NAME" "$REMOTE:$REMOTE_PATH"; then
              echo "Upload complete"
              exit 0
            fi

            if [ "$attempt" -lt "$RETRIES" ]; then
              echo "Upload failed, retrying in ${SLEEP_BETWEEN}s"
              sleep "$SLEEP_BETWEEN"
            else
              echo "::error::Failed to upload archive after ${RETRIES} attempts"
              exit 1
            fi
          done

      - name: Deploy on remote host
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          password: ${{ env.SSH_PASSWORD }}
          port: ${{ env.SSH_PORT }}
          script: |
            set -eu
            if [ -n "${BASH:-}" ]; then
              set -o pipefail
            fi

            ARCHIVE_DIR="$HOME/deployments"
            ARCHIVE_NAME="deploy.tar.gz"
            ARCHIVE_PATH="$ARCHIVE_DIR/$ARCHIVE_NAME"
            APP_DIR="$HOME/apps/hadirahjou.ir"

            mkdir -p "$ARCHIVE_DIR"

            if command -v sudo >/dev/null 2>&1; then
              SUDO="sudo"
            else
              SUDO=""
            fi

            # Remove old deployment
            rm -rf "$APP_DIR"
            mkdir -p "$APP_DIR"
            
            # Extract static files (out directory) to app directory
            # The archive contains 'out/' directory, so we extract it directly
            tar -xzf "$ARCHIVE_PATH" -C "$APP_DIR"
            rm -f "$ARCHIVE_PATH"
            
            # Verify the out directory exists and has files
            if [ ! -d "$APP_DIR/out" ] || [ -z "$(ls -A $APP_DIR/out 2>/dev/null)" ]; then
              echo "Error: out directory is missing or empty after extraction"
              echo "APP_DIR contents:"
              ls -la "$APP_DIR" || true
              if [ -f "$ARCHIVE_PATH" ]; then
                echo "Archive contents:"
                tar -tzf "$ARCHIVE_PATH" 2>/dev/null | head -20 || echo "Could not list archive"
              fi
              exit 1
            fi
            
            # Set proper permissions for nginx to read the files
            chmod -R 755 "$APP_DIR/out"
            find "$APP_DIR/out" -type f -exec chmod 644 {} \;
            
            echo "Static files extracted successfully to $APP_DIR/out"
            echo "Contents of out directory:"
            ls -la "$APP_DIR/out" | head -20 || true
            echo "Checking for index.html:"
            ls -la "$APP_DIR/out/index.html" || echo "WARNING: index.html not found!"
            
            # Update nginx config with the correct absolute path
            SITE_CONF="/etc/nginx/sites-available/hadirahjou-ir"
            if [ -f "$SITE_CONF" ]; then
              # Get absolute path
              ABS_APP_DIR="$(cd "$APP_DIR" && pwd)"
              # Update the root path in nginx config
              $SUDO sed -i "s|root .*;|root $ABS_APP_DIR/out;|" "$SITE_CONF"
              echo "Updated nginx config with path: $ABS_APP_DIR/out"
              $SUDO nginx -t || echo "WARNING: nginx config test failed"
            fi

            # Reload nginx to serve the new static files
            if command -v nginx >/dev/null 2>&1; then
              if command -v systemctl >/dev/null 2>&1; then
                $SUDO systemctl reload nginx || $SUDO systemctl restart nginx || true
              else
                $SUDO nginx -s reload || $SUDO service nginx reload || true
              fi
            fi
